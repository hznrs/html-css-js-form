<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>mesaj simÃ¼lasyonu</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #1e1e1e;
      color: #ffffff;
      margin: 0;
      padding: 0;
    }
    #chatbox {
      background: #2c2c2c;
      max-width: 600px;
      margin: auto;
      height: 100vh;
      display: flex;
      flex-direction: column;
      padding: 0;
    }
    #header {
      background-color: #0088cc;
      color: white;
      padding: 12px;
      font-size: 18px;
      text-align: center;
    }
    #chat {
      flex: 1;
      padding: 15px;
      overflow-y: auto;
    }
    .message {
      margin: 10px 0;
      padding: 10px 15px;
      border-radius: 15px;
      background-color: #3a3a3a;
      width: fit-content;
      max-width: 100%;
      overflow: visible;
    }
    .user {
      font-weight: bold;
      color: #4ea3e3;
    }
    .typing {
      font-style: italic;
      color: #888;
      margin: 10px 0;
    }
    .options {
      background-color: #262626;
      padding: 10px;
      border-top: 1px solid #444;
    }
    .options button {
      display: block;
      margin: 8px 0;
      padding: 10px;
      width: 100%;
      border-radius: 6px;
      border: none;
      font-size: 15px;
      cursor: pointer;
      color: #fff;
    }
    .good { background-color: #0088ff; }
    .bad  { background-color: #0088ff; }
  </style>
</head>
<body>

<div id="chatbox">
  <div id="header">Ã‡izim AtÃ¶lyesi Grubu</div>
  <div id="chat"></div>
  <div class="options" id="choices"></div>
</div>

<script>
/** En gÃ¼ncel Web App URLâ€™Ä°NÄ° buraya koy **/
const WEB_APP_URL = "https://script.google.com/kendi_uzantÄ±nÄ±_ekle/exec";

const chat = document.getElementById("chat");
const choices = document.getElementById("choices");

// GÃ¶rselleri <img> ile gÃ¶sterelim (iframe deÄŸil) kendin mesaj kutusuna dizi ekleyebilirsin.
const conversations = [
  [
    { user: "Arda",  text: "Hangi kalemi kullanÄ±yorsun Ekin?" },
    { user: "Hazan", text: "GeÃ§en paylaÅŸÄ±lan videodaki Ã§ok tavsiye ediliyormuÅŸ. Kullanan var mÄ±?" },
    { user: "Ekin",  text: "ArkadaÅŸÄ±m ondan kullanÄ±yor, Ã§ok memnun deÄŸildi. Ben kendi kullandÄ±ÄŸÄ±mdan memnunum ama." },
    { user: "Hazan", text: "Ã‡izim detaylarÄ±nÄ±, renk geÃ§iÅŸlerini vs. gÃ¶rebilmemiz iÃ§in Ã¶rnek bir Ã§izimin var mÄ±?" },
    { user: "Ekin",  text: "<img src='1.png' alt='Ekin Ã‡izim' style='border-radius:8px; max-width:100%; height:auto;'/>" },
    { user: "Deniz", text: "kalemi almamak iÃ§in ikna edici bir gÃ¶rsel olmuÅŸ ğŸ¤£ğŸ˜‚" },
    { user: "Ekin",  text: "NasÄ±l yani?" },
    { user: "Deniz", text: "Ä°ÅŸi ehline mi bÄ±rakmak lazÄ±m acaba ya, ne dersin?" }
  ],
  [
    { user: "Ekin",  text: " Ben kendi tarzÄ±mda ilerlemeye Ã§alÄ±ÅŸÄ±yorum, belki herkesin beÄŸenisi aynÄ± deÄŸil :)" },
    { user: "Deniz", text: "Tarz diyorsun da biraz daha Ã¶zen gÃ¶stermek tarzdan sayÄ±lmaz bence ğŸ¤·â€â™‚ï¸" },
    { user: "Ekin",  text: "Peki o zaman daha Ã§ok emek ve zaman ayÄ±rÄ±p renklendirdiÄŸim birkaÃ§ sahneyi atÄ±yorum. Bu nasÄ±l olmuÅŸ?" },
    { user: "Ekin",  text: "<img src='2.png' alt='Ekin Ã‡izim' style='border-radius:8px; max-width:100%; height:auto;'/>" },
    { user: "Deniz", text: "Yine klasik pastel tonlar, yaratÄ±cÄ±lÄ±k tatilde mi acaba? ğŸ™ƒ" },
    { user: "Hazan", text: "Kalemin gayet iyi ekin fakat bana kalÄ±rsa genelde kendini tekrarladÄ±ÄŸÄ±n ve hep aynÄ± tarz Ã§alÄ±ÅŸtÄ±ÄŸÄ±n iÃ§in yavaÅŸ geliÅŸiyor Ã§alÄ±ÅŸmalarÄ±n." },
    { user: "Arda",  text: "Ã‡izim iÅŸleri Ã§ok kiÅŸisel bir alan. Kimi eleÅŸtiri motive eder, kimini kÄ±rabilir. Dengeyi bulmak zor gerÃ§ekten." }
  ]
];

const options = [
  [
    { text: " Bence Ã§izimin gayet gÃ¼zel Ekin, herkesin tarzÄ± farklÄ±dÄ±r. Ã–nemli olan senin emeÄŸin ve geliÅŸimin.", type: "good" },
    { text: " Deniz, bu ÅŸekilde yorum yapmak kÄ±rÄ±cÄ± olabilir. EleÅŸtiri yapacaksak biraz daha saygÄ±lÄ± olabiliriz, deÄŸil mi?", type: "good" },
    { text: " Ã‡izimi gÃ¶rÃ¼nce sanki ben de vazgeÃ§erdim almaktan ğŸ¤£", type: "bad" },
    { text: " Deniz gÃ¼ldÃ¼rdÃ¼n ya ğŸ˜‚ biraz sert olmuÅŸ ama komikti.", type: "bad" }
  ],
  [
    { text: "Bence renk seÃ§imlerin Ã§ok yumuÅŸak ve uyumlu Ekin, Ã§iziminin bir tarzÄ± var. Bozma moralini.", type: "good" },
    { text: "Deniz, yorumun biraz kÃ¼Ã§Ã¼mseyici olmuÅŸ gibi. Daha yapÄ±cÄ± bir ÅŸekilde sÃ¶yleyemez miydik bunu?", type: "good" },
    { text: "Ahah evet, tatildeymiÅŸ gibi olmuÅŸ gerÃ§ekten ğŸ™ƒ pastel Ã§Ä±lgÄ±nlÄ±ÄŸÄ±...", type: "bad" },
    { text: "Denizâ€™in lafÄ± biraz sivri ama sanki haklÄ±lÄ±k payÄ± da var gibi ", type: "bad" }
  ]
];

let sceneIndex = 0;
let messageIndex = 0;
let userResponses = 0;
let selectedAnswers = [];

// sessionIdâ€™yi garantiye al
(function ensureSession() {
  try {
    if (!localStorage.getItem('sessionId')) {
      const id = (crypto && crypto.randomUUID) ? crypto.randomUUID() : String(Date.now()) + Math.random();
      localStorage.setItem('sessionId', id);
    }
  } catch (e) {}
})();

function showTyping(callback) {
  const typing = document.createElement("div");
  typing.classList.add("typing");
  typing.textContent = "YazÄ±yor...";
  chat.appendChild(typing);
  chat.scrollTop = chat.scrollHeight;

  setTimeout(() => {
    chat.removeChild(typing);
    callback();
  }, 1000);
}

function showNextMessage() {
  const currentScene = conversations[sceneIndex];

  if (messageIndex < currentScene.length) {
    const msg = currentScene[messageIndex];
    showTyping(() => {
      const div = document.createElement("div");
      div.classList.add("message");
      div.innerHTML = `<span class="user">${msg.user}:</span> ${msg.text}`;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
      messageIndex++;
      setTimeout(showNextMessage, 800);
    });
  } else {
    setTimeout(displayOptions, 600);
  }
}

function displayOptions() {
  choices.innerHTML = "";
  const opts = options[sceneIndex];
  opts.forEach(opt => {
    const btn = document.createElement("button");
    btn.classList.add(opt.type);
    btn.textContent = opt.text;
    btn.onclick = () => respond(opt.text);
    choices.appendChild(btn);
  });
}

function respond(text) {
  selectedAnswers.push({ scene: sceneIndex + 1, answer: text });

  const div = document.createElement("div");
  div.classList.add("message");
  div.innerHTML = `<span class="user">Sen:</span> ${text}`;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;

  userResponses++;
  choices.innerHTML = "";

  if (userResponses < conversations.length) {
    sceneIndex++;
    messageIndex = 0;
    setTimeout(showNextMessage, 600);
  } else {
    const finalDiv = document.createElement("div");
    finalDiv.classList.add("message");
    finalDiv.innerHTML = "<em>Etkinlik sona erdi. Tepkileriniz deÄŸerlendirildi. TeÅŸekkÃ¼rler.</em>";
    chat.appendChild(finalDiv);
    choices.innerHTML = "";

    // --- GÃ–NDERME BLOÄU ---
    const sessionId = (function() {
      try {
        const existing = localStorage.getItem('sessionId');
        if (existing) return existing;
        const id = (crypto && crypto.randomUUID) ? crypto.randomUUID() : String(Date.now()) + Math.random();
        localStorage.setItem('sessionId', id);
        return id;
      } catch (e) {
        return String(Date.now()) + Math.random();
      }
    })();

    const payload = {
      sessionId,
      userAgent: navigator.userAgent,
      level: localStorage.getItem('selectedTangram') || null,
      answers: selectedAnswers,               // CEVAPLAR BURADA
      source: "index.html",
      timestamp: new Date().toISOString()
    };

    const bodyStr = JSON.stringify(payload);
    const blob = new Blob([bodyStr], { type: "text/plain" });

    (async () => {
      let delivered = false;
      try {
        if (navigator.sendBeacon) {
          delivered = navigator.sendBeacon(WEB_APP_URL, blob);
        }
      } catch (_) {}

      if (!delivered) {
        try {
          await fetch(WEB_APP_URL, {
            method: "POST",
            mode: "no-cors",
            headers: { "Content-Type": "text/plain" },
            body: bodyStr,
            keepalive: true   // sayfa deÄŸiÅŸse de isteÄŸi tamamlamayÄ± dener
          });
        } catch (_) {}
      }

      // KÃ¼Ã§Ã¼k gecikme: postâ€™un flush edilmesine yardÄ±mcÄ± olur
      setTimeout(() => {
        window.location.href = "./index2.html";
      }, 150);
    })();
  }
}

showNextMessage();
</script>

</body>
</html>
